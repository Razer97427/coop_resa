<?php
require_once 'config.php'; 
include 'includes/header.php';

// V√©rification Manager
if (($_SESSION['user_role'] ?? '') !== 'Manager') {
    echo "<script>window.location.href='index.php';</script>";
    exit();
}

// --- 1. LOGIQUE DE VALIDATION / REFUS ---
if (isset($_GET['action']) && isset($_GET['id'])) {
    $action = $_GET['action'];
    $id = (int)$_GET['id'];
    $statut = ($action == 'valider') ? 'Valid√©e' : (($action == 'refuser') ? 'Refus√©e' : '');
    
    if ($statut) {
        $stmt = $conn->prepare("UPDATE reservations SET statut_resa = ? WHERE id_reservation = ?");
        $stmt->bind_param("si", $statut, $id);
        $stmt->execute();
        echo "<script>window.location.href='manager.php';</script>";
        exit();
    }
}

// --- 2. FILTRES DE RECHERCHE ---
$search_keyword = $_GET['search'] ?? '';
$search_date = $_GET['date'] ?? '';

// Construction de la clause WHERE dynamique
$filter_sql = "";
$filter_params = [];
$filter_types = "";

if (!empty($search_keyword)) {
    // Recherche large : Nom OU Pr√©nom OU Matricule Employ√© OU Immatriculation V√©hicule
    $filter_sql .= " AND (e.nom LIKE ? OR e.prenom LIKE ? OR e.matricule LIKE ? OR v.immatriculation LIKE ?)";
    $term = "%$search_keyword%";
    array_push($filter_params, $term, $term, $term, $term);
    $filter_types .= "ssss";
}

if (!empty($search_date)) {
    // Recherche par date exacte de d√©but
    $filter_sql .= " AND DATE(r.date_debut_resa) = ?";
    $filter_params[] = $search_date;
    $filter_types .= "s";
}

// --- 3. CHARGEMENT DES DONN√âES FILTR√âES ---

// A. Requ√™te "En attente"
$sql_demandes = "
    SELECT r.*, e.nom, e.prenom, e.matricule, v.marque, v.modele, v.immatriculation 
    FROM reservations r 
    JOIN employes e ON r.id_employe = e.id_employe 
    JOIN vehicules v ON r.id_vehicule = v.id_vehicule 
    WHERE r.statut_resa = 'En attente' $filter_sql
    ORDER BY r.date_debut_resa ASC";

$stmt_demandes = $conn->prepare($sql_demandes);
if (!empty($filter_params)) {
    $stmt_demandes->bind_param($filter_types, ...$filter_params);
}
$stmt_demandes->execute();
$demandes = $stmt_demandes->get_result();

// B. Requ√™te "Historique Global" (Valid√©e, Termin√©e, Annul√©e, Refus√©e)
$sql_historique = "
    SELECT r.*, e.nom, e.prenom, e.matricule, v.marque, v.modele, v.immatriculation 
    FROM reservations r 
    JOIN employes e ON r.id_employe = e.id_employe 
    JOIN vehicules v ON r.id_vehicule = v.id_vehicule 
    WHERE r.statut_resa != 'En attente' $filter_sql 
    ORDER BY r.date_debut_resa DESC LIMIT 50";

$stmt_historique = $conn->prepare($sql_historique);
if (!empty($filter_params)) {
    $stmt_historique->bind_param($filter_types, ...$filter_params);
}
$stmt_historique->execute();
$historique = $stmt_historique->get_result();
?>

<h2>üõ†Ô∏è Dashboard Manager</h2>

<!-- BARRE DE RECHERCHE -->
<div class="form-container" style="background-color: #e9ecef; border: 1px solid #dee2e6; padding: 15px;">
    <h3 style="margin-top:0; font-size:1.1rem;">üîç Rechercher une r√©servation</h3>
    <form action="manager.php" method="GET">
        <div class="time-group">
            <div style="flex: 2;">
                <label style="margin-top:0;">Mots-cl√©s</label>
                <input type="text" name="search" value="<?php echo htmlspecialchars($search_keyword); ?>" 
                       placeholder="Nom, Pr√©nom, Matricule ou Immatriculation...">
            </div>
            <div style="flex: 1;">
                <label style="margin-top:0;">Date</label>
                <input type="date" name="date" value="<?php echo htmlspecialchars($search_date); ?>">
            </div>
        </div>
        <div style="margin-top: 10px; display: flex; gap: 10px;">
            <button type="submit" class="action-btn charge-btn" style="width: auto; margin-top:0;">Rechercher</button>
            <a href="manager.php" class="action-btn cancel-btn" style="text-decoration:none; padding:10px 20px;">R√©initialiser</a>
        </div>
    </form>
</div>

<h3>üîî En attente (<?php echo $demandes->num_rows; ?>)</h3>
<table>
    <thead>
        <tr>
            <th>Demandeur</th>
            <th>V√©hicule</th>
            <th>Dates</th>
            <th>Motif</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
    <?php if ($demandes->num_rows > 0): ?>
        <?php while ($row = $demandes->fetch_assoc()): ?>
        <tr>
            <td data-label="Demandeur">
                <?php echo htmlspecialchars($row['prenom'] . ' ' . $row['nom']); ?>
                <br><small class="text-muted"><?php echo htmlspecialchars($row['matricule']); ?></small>
            </td>
            <td data-label="V√©hicule">
                <?php echo htmlspecialchars($row['marque'] . ' ' . $row['modele']); ?>
                <br><small class="text-muted"><?php echo htmlspecialchars($row['immatriculation']); ?></small>
            </td>
            <td data-label="Dates"><?php echo date('d/m H:i', strtotime($row['date_debut_resa'])); ?></td>
            <td data-label="Motif"><?php echo htmlspecialchars($row['motif']); ?></td>
            <td data-label="Actions">
                <a href="manager.php?action=valider&id=<?php echo $row['id_reservation']; ?>" class="action-btn charge-btn">Valider</a>
                <a href="manager.php?action=refuser&id=<?php echo $row['id_reservation']; ?>" class="action-btn cancel-btn">Refuser</a>
            </td>
        </tr>
        <?php endwhile; ?>
    <?php else: ?>
        <tr><td colspan="5" class="text-center">Aucune demande en attente.</td></tr>
    <?php endif; ?>
    </tbody>
</table>

<hr>

<h3>üìÇ Historique Global</h3>
<table class="historique-global-table">
    <thead>
        <tr>
            <th>Statut</th>
            <th>Qui ?</th>
            <th>Quoi ?</th>
            <th>Quand ?</th>
            <th>Note Retour</th>
        </tr>
    </thead>
    <tbody>
    <?php if ($historique->num_rows > 0): ?>
        <?php while ($row = $historique->fetch_assoc()): ?>
        <tr class="<?php echo ($row['statut_resa'] == 'Annul√©e' || $row['statut_resa'] == 'Refus√©e') ? 'archived' : ''; ?>">
            <td data-label="Statut">
                <span class="status-tag <?php echo strtolower(str_replace(' ', '-', $row['statut_resa'])); ?>">
                    <?php echo htmlspecialchars($row['statut_resa']); ?>
                </span>
            </td>
            <td data-label="Qui">
                <?php echo htmlspecialchars($row['prenom'] . ' ' . $row['nom']); ?>
                <br><small class="text-muted"><?php echo htmlspecialchars($row['matricule']); ?></small>
            </td>
            <td data-label="Quoi">
                <?php echo htmlspecialchars($row['marque'] . ' ' . $row['modele']); ?>
                <br><small class="text-muted"><?php echo htmlspecialchars($row['immatriculation']); ?></small>
            </td>
            <td data-label="Quand">
                <?php echo date('d/m', strtotime($row['date_debut_resa'])); ?> 
                <?php if ($row['date_retour_reel']) echo " (Rendu le " . date('d/m', strtotime($row['date_retour_reel'])) . ")"; ?>
            </td>
            <td data-label="Note">
                <?php if (!empty($row['commentaire_retour'])): ?>
                    <span class="text-danger">!</span> <?php echo htmlspecialchars($row['commentaire_retour']); ?>
                <?php endif; ?>
            </td>
        </tr>
        <?php endwhile; ?>
    <?php else: ?>
        <tr><td colspan="5" class="text-center">Aucun historique trouv√©.</td></tr>
    <?php endif; ?>
    </tbody>
</table>

<?php 
$conn->close();
include 'includes/footer.php'; 
?>